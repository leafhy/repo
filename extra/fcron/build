#!/bin/sh -e
#
# Build fails as USER chown: changing ownership of pkg/fcron/usr/sbin : Operation not permitted

getent group fcron || addgroup -S -g 997 fcron
getent passwd fcron || adduser -H -h /var/spool/fcron -s /bin/sh -D -S -G fcron -u 997 -g "Unprivileged User" fcron

sed 's/ fr//' doc/Makefile.in > _
mv -f _ doc/Makefile.in

sed '25s/sbindir/bindir/' Makefile.in > _
mv -f _ Makefile.in

sed 's/-O2 //g' configure.in > _
mv -f _ configure.in

./configure \
        --prefix=/usr \
        --with-boot-install=no \
        --with-systemdsystemunitdir=no \
        --with-docdir=/usr/share/doc \
        --localstatedir=/var \
        --mandir=/usr/share/man \
        --sysconfdir=/etc
        
        
make
make DESTDIR="$1" install

install -dm755 $1/etc/cron.hourly
install -dm755 $1/etc/cron.daily
install -dm755 $1/etc/cron.weekly
install -dm755 $1/etc/cron.monthly

install -m640 systab.orig $1/var/spool/fcron/systab.orig
install -m755 run-parts $1/usr/bin/run-parts

# Install runit services.
install -Dm755 fcron.run $1/etc/sv/fcron/run
ln -sf /etc/sv/fcron $1/var/service/
